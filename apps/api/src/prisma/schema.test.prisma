generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Event {
  id          String         @id @default(cuid())
  source      String
  triggerer   String
  severity    String
  type        String
  timestamp   DateTime       @default(now())
  metadata    String
  title       String
  description String?
  itemId      String?

  user        User?      @relation(fields: [userId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  userId      String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  workspaceId String?
}

model Notification {
  id        String           @id @default(cuid())
  createdAt DateTime         @default(now())
  readAt    DateTime?
  type      String
  message   String
  link      String?
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId    String
}

model User {
  id                   String        @id @default(cuid())
  email                String        @unique
  name                 String?
  profilePictureUrl    String?
  isActive             Boolean       @default(true)
  isOnboardingFinished Boolean       @default(false)
  isAdmin              Boolean       @default(false)
  authProvider         String
  subscription         Subscription?

  workspaceMembers WorkspaceMember[]
  workspaces       Workspace[]
  apiKeys          ApiKey[]
  otp              Otp?
  notifications    Notification[]
  secrets          Secret[] // Stores the secrets the user updated
  variables        Variable[] // Stores the variables the user updated
  projects         Project[] // Stores the projects the user updated
  environments     Environment[] // Stores the environments the user updated
  secretVersion    SecretVersion[]
  variableVersion  VariableVersion[]
  events           Event[]

  @@index([email], name: "email")
}

model Subscription {
  id       String  @id @default(cuid())
  plan     String
  isActive Boolean @default(true)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId String @unique
}

model Integration {
  id        String          @id @default(cuid())
  name      String
  slug      String          @unique
  metadata  String
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  type      String
  notifyOn  String

  // An integration will always be tied to a workspace
  workspace     Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  workspaceId   String
  // An integration may or may not have relations with projects
  project       Project?     @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  projectId     String?
  // An integration may or may not have relations with environments
  environment   Environment? @relation(fields: [environmentId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  environmentId String?

  @@unique([workspaceId, name])
}

model Environment {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  lastUpdatedBy   User?   @relation(fields: [lastUpdatedById], references: [id], onUpdate: Cascade, onDelete: SetNull)
  lastUpdatedById String?

  secretVersions   SecretVersion[]
  variableVersions VariableVersion[]
  integrations     Integration[]

  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  projectId String

  projectWorkspaceRoleAssociations ProjectWorkspaceRoleAssociation[]

  @@unique([projectId, name])
  @@index([name])
}

model Project {
  id              String             @id @default(cuid())
  name            String
  slug            String             @unique
  description     String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  publicKey       String
  privateKey      String? // We store this only if the user wants us to do so! 
  storePrivateKey Boolean            @default(false)
  isDisabled      Boolean            @default(false) // This is set to true when the user stops his subscription and still has premium features in use
  accessLevel     String             @default("PRIVATE")
  isForked        Boolean            @default(false)

  lastUpdatedBy   User?   @relation(fields: [lastUpdatedById], references: [id], onUpdate: Cascade, onDelete: SetNull)
  lastUpdatedById String?

  workspaceId    String
  workspace      Workspace                         @relation(fields: [workspaceId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  secrets        Secret[]
  variables      Variable[]
  environments   Environment[]
  workspaceRoles ProjectWorkspaceRoleAssociation[]
  integrations   Integration[]
  forks          Project[]                         @relation("Fork")

  forkedFromId String?
  forkedFrom   Project? @relation("Fork", fields: [forkedFromId], references: [id], onDelete: SetNull, onUpdate: Cascade)
}

model ProjectWorkspaceRoleAssociation {
  id String @id @default(cuid())

  role   WorkspaceRole @relation(fields: [roleId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  roleId String

  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  projectId String

  environments Environment[]

  @@unique([roleId, projectId])
}

model WorkspaceRole {
  id                String   @id @default(cuid())
  name              String
  slug              String   @unique
  description       String?
  colorCode         String?
  hasAdminAuthority Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  authorities      String
  workspaceMembers WorkspaceMemberRoleAssociation[]
  projects         ProjectWorkspaceRoleAssociation[]

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([workspaceId, name])
}

model WorkspaceMemberRoleAssociation {
  id String @id @default(cuid())

  role   WorkspaceRole @relation(fields: [roleId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  roleId String

  workspaceMember   WorkspaceMember @relation(fields: [workspaceMemberId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  workspaceMemberId String

  @@unique([roleId, workspaceMemberId])
}

// This model stores the membership of a workspace-user and their roles.
model WorkspaceMember {
  id                 String                           @id @default(cuid())
  user               User                             @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId             String
  workspace          Workspace                        @relation(fields: [workspaceId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  workspaceId        String
  invitationAccepted Boolean                          @default(false)
  roles              WorkspaceMemberRoleAssociation[]
  createdOn          DateTime                         @default(now())

  @@unique([workspaceId, userId])
}

model SecretVersion {
  id      String @id @default(cuid())
  value   String
  version Int    @default(1)

  secretId String
  secret   Secret @relation(fields: [secretId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  createdOn   DateTime @default(now())
  createdBy   User?    @relation(fields: [createdById], references: [id], onUpdate: Cascade, onDelete: SetNull)
  createdById String?

  environmentId String
  environment   Environment @relation(fields: [environmentId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([secretId, environmentId])
}

model Secret {
  id          String          @id @default(cuid())
  name        String
  slug        String          @unique
  versions    SecretVersion[] // Stores the versions of the secret
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  rotateAt    DateTime?
  rotateAfter Int?
  note        String?

  lastUpdatedBy   User?   @relation(fields: [lastUpdatedById], references: [id], onUpdate: Cascade, onDelete: SetNull)
  lastUpdatedById String?

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([projectId, name])
}

model VariableVersion {
  id      String @id @default(cuid())
  value   String
  version Int    @default(1)

  variableId String
  variable   Variable @relation(fields: [variableId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  createdOn   DateTime @default(now())
  createdBy   User?    @relation(fields: [createdById], references: [id], onUpdate: Cascade, onDelete: SetNull)
  createdById String?

  environmentId String
  environment   Environment @relation(fields: [environmentId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([variableId, environmentId])
}

model Variable {
  id        String            @id @default(cuid())
  name      String
  slug      String            @unique
  versions  VariableVersion[] // Stores the versions of the variable
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  note      String?

  lastUpdatedBy   User?   @relation(fields: [lastUpdatedById], references: [id], onUpdate: Cascade, onDelete: SetNull)
  lastUpdatedById String?

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([projectId, name])
}

model ApiKey {
  id          String      @id @default(cuid())
  name        String
  preview     String      @default("ks_******")
  slug        String      @unique
  value       String      @unique
  expiresAt   DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  authorities String

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId String

  @@unique([userId, name])
}

model Otp {
  id          String           @id @default(cuid())
  code        String           @unique
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId      String           @unique
  createdAt   DateTime         @default(now())
  expiresAt   DateTime
  emailChange UserEmailChange?

  @@unique([userId, code], name: "userCode")
  @@index([expiresAt], name: "expiresAt")
}

model Workspace {
  id                      String   @id @default(cuid())
  name                    String
  slug                    String   @unique
  isFreeTier              Boolean  @default(true)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  ownerId                 String
  isDefault               Boolean  @default(false)
  icon                    String?

  lastUpdatedBy   User?   @relation(fields: [lastUpdatedById], references: [id], onUpdate: Cascade, onDelete: SetNull)
  lastUpdatedById String?

  projects     Project[]
  members      WorkspaceMember[]
  roles        WorkspaceRole[]
  events       Event[]
  integrations Integration[]

  @@unique([name, ownerId])
}

model ChangeNotificationSocketMap {
  id            String @id @default(cuid())
  socketId      String
  environmentId String

  @@index([environmentId, socketId])
}

model UserEmailChange {
  id       String @id @default(cuid())
  otp      Otp    @relation(fields: [otpId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  otpId    String @unique
  newEmail String
}
